---
import React, { useContext } from "react";
// import Link from 'next/link';
// import Image from 'next/image';
// import { Image } from '@astrojs/image/components';
import { useTheme } from '@mui/material/styles';
import { AppBar, Toolbar, Button, Tooltip, Icon as MuiIcon, IconButton, Box, ButtonBase } from '@mui/material';
import { Popper, ClickAwayListener, Typography, Paper, Checkbox, FormControlLabel, FormHelperText } from "@mui/material";
import { useStore } from '@nanostores/react';
import { userProfile } from '../utils/userStore';
// const $userProfile = useStore(userProfile);

import axios from 'axios';

import { settings } from '../utils/settings';
// import { useAuth } from 'oidc-react';
// @ts-ignore
import OAuth2Login from 'react-simple-oauth2-login';
import LoginOrcid from '../components/LoginOrcid';
import UserContext from '../utils/UserContext'
import Icon from '../components/Icon';

const theme = useTheme();
// const auth = useAuth();

const { user, setUser }: any = useContext(UserContext)

const [state, setState] = React.useState({
  currentUsername: null,
  accessToken: null,
  loggedIn: false
});
const stateRef = React.useRef(state);
// Avoid conflict when async calls
const updateState = React.useCallback((update: any) => {
  stateRef.current = {...stateRef.current, ...update};
  setState(stateRef.current);
}, [setState]);

---
<AppBar title="" position='static'>
  <Toolbar variant='dense'>
    <a href="/" style={{alignItems: 'center', display: 'flex'}}>
      {/* <Tooltip title='☑️ Knowledge Collaboratory'> */}
        {/* <img src={iconImage} style={{height: '2em', width: '2em', marginRight: '10px'}} alt="Logo" /> */}
        {/* <Image
          src="/icon.png"
          alt="Logo"
          width={32}
          height={32}
        /> */}
        KC
      {/* </Tooltip> */}
    </a>
    <a href="/" class="linkButton">
      <Tooltip title='Browse Nanopublications'>
        <Button style={{color: '#fff', textTransform: 'none', marginLeft: theme.spacing(2)}}>
          <Icon id="search" />&nbsp;Browse Nanopublications
        </Button>
      </Tooltip>
    </a>
    <a href="/annotate" class="linkButton">
      {/* <Tooltip title='Annotate biomedical text, and publish the assertion as Nanopublication'> */}
        <Button style={{color: '#fff', textTransform: 'none', marginLeft: theme.spacing(2)}}>
          <Icon id="local_offer" />&nbsp;Annotate biomedical text
        </Button>
      {/* </Tooltip> */}
    </a>
    <a href="/shape-publisher" class="linkButton">
      {/* <Tooltip title='Define and publish RDF nanopublications from SHACL shapes'> */}
        <Button style={{color: '#fff', textTransform: 'none', marginLeft: theme.spacing(2)}}>
          <Icon id="dynamic_form" />&nbsp;Shape publisher
        </Button>
      {/* </Tooltip> */}
    </a>
    <div class="flexGrow"></div>

    {/* <Tooltip title='Access the OpenAPI documentation of the API used by this service'> */}
      <Button style={{color: '#fff', textTransform: 'none'}} target="_blank" rel="noopener noreferrer"
      href={settings.docsUrl}>
        <MuiIcon style={{display: 'flex', marginRight: theme.spacing(1), padding: theme.spacing(0)}}>
          <img
            src="/openapi_logo.svg"
            alt="OpenAPI"
            width={18}
            height={18}
            // fill
          />
        </MuiIcon> API
      </Button>
    {/* </Tooltip> */}
    <a href="/about" class="linkButton">
      {/* <Tooltip title='About'> */}
        <Button style={{color: '#fff'}}>
        <Icon id="info" />
        </Button>
      {/* </Tooltip> */}
    </a>
    {/* <Tooltip title='Source code'> */}
      <Button style={{color: '#fff'}} target="_blank" href="https://github.com/MaastrichtU-IDS/knowledge-collaboratory">
        <MuiIcon style={{display: 'flex', marginRight: theme.spacing(1), padding: theme.spacing(0)}}>
          <img
              src="/github.svg"
              alt="GitHub"
              width={18}
              height={18}
              // fill
            />
        </MuiIcon>
      </Button>
    {/* </Tooltip> */}

    {/* <UserContext.Consumer>
      {({ user }) => (
        { user.username &&
          <Button variant='contained' onClick={showUserInfo} color='secondary' size='small'
              style={{textTransform: 'none'}}>
            🐧 {user.username}
          </Button>
        }
      )}
      </UserContext.Consumer> */}

      { user && user.username &&
          <Button variant='contained' onClick={showUserInfo} color='secondary' size='small'
              style={{textTransform: 'none'}}>
            🐧 {user.username}
          </Button>
      }

      {/* { !user || !user.username && */}
        <OAuth2Login
          class="loginButton"
          authorizationUrl="https://orcid.org/oauth/authorize"
          // authorizationUrl="https://orcid.org/.well-known/openid-configuration"
          responseType="token"
          clientId={settings.orcidClientId}
          redirectUri={settings.frontendUrl}
          scope="/authenticate"
          onSuccess={onSuccess}
          onFailure={onFailure}>
            <Button variant='contained' color='secondary' component="span" size='small' style={{textTransform: 'none'}}>
              Login with ORCID
              {/* <Image src="/orcid_logo.svg" alt="ORCID" width={20} height={20} style={{marginLeft: theme.spacing(1)}} /> */}
            </Button>
        </OAuth2Login>
      {/* } */}
      { user && user.username &&
        <Popper open={open} anchorEl={anchorEl}>
          <ClickAwayListener onClickAway={handleClickAway}>
            <Paper elevation={4} style={{padding: theme.spacing(2, 2), textAlign: 'left'}}>
              <Typography style={{marginBottom: theme.spacing(1)}}>
                Logged in with ORCID: {<a href={user.id}  target="_blank" rel="noopener noreferrer">{user.id}</a>}
              </Typography>
              <Typography style={{marginBottom: theme.spacing(1)}}>
                Username: {user.username}
              </Typography>
              <Button onClick={logout} variant='contained' size='small' startIcon={<Icon id="logout" />}>
                Logout
              </Button>
            </Paper>
          </ClickAwayListener>
        </Popper>
      }

      {/* </Button> */}
      {/* </Tooltip> */}

    {/* <Tooltip title='Login with ORCID'>
      <Button href="http://localhost:8000/rest/login" style={{color: '#fff'}} >
        <LoginIcon />
      </Button>
    </Tooltip> */}
    {/* <Tooltip title='Login with ORCID'>
      <Button onClick={() => {auth.signIn()}} style={{color: '#fff'}} >
        <LoginIcon />
      </Button>
    </Tooltip> */}

  </Toolbar>
</AppBar>